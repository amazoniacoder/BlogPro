/**
 * TextColorPicker Integration Tests
 * Tests integration with ModernFormatService and ColorUtils
 */

import '../setup';
// @ts-ignore: React is used for JSX
import React from 'react';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { ModernFormatService } from '../../core/services/ModernFormatService';
import { ColorUtils } from '../../shared/utils/ColorUtils';
import { TextColorPicker } from '../../core/components/TextColorPicker';

// Test globals
declare global {
  var describe: any;
  var test: any;
  var expect: any;
  var beforeEach: any;
  var vi: any;
}

// Mock ModernFormatService
vi.mock('../../core/services/ModernFormatService', () => ({
  ModernFormatService: {
    applyTextColor: vi.fn(),
    applyBackgroundColor: vi.fn(),
    getFormatState: vi.fn(() => ({
      bold: false,
      italic: false,
      underline: false,
      fontSize: '12pt',
      fontFamily: 'Arial',
      textAlign: 'left'
    }))
  }
}));

describe('TextColorPicker Integration', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    
    // Setup DOM environment
    document.body.innerHTML = '<div class="editor-content"><p>Test content</p></div>';
  });

  describe('Service Integration', () => {
    test('calls ModernFormatService.applyTextColor when text color changes', async () => {
      const user = userEvent.setup();
      const mockOnChange = vi.fn((color: string) => {
        ModernFormatService.applyTextColor(color);
      });
      
      render(
        <TextColorPicker
          currentColor="#000000"
          onColorChange={mockOnChange}
          type="text"
        />
      );
      
      // Open dropdown and select red
      const trigger = screen.getByRole('button');
      await user.click(trigger);
      
      const redOptions = screen.getAllByTitle('Red');
      const redOption = redOptions[0]; // Basic red
      await user.click(redOption);
      
      expect(mockOnChange).toHaveBeenCalledWith('#ff0000');
      expect(ModernFormatService.applyTextColor).toHaveBeenCalledWith('#ff0000');
    });

    test('calls ModernFormatService.applyBackgroundColor when background color changes', async () => {
      const user = userEvent.setup();
      const mockOnChange = vi.fn((color: string) => {
        ModernFormatService.applyBackgroundColor(color);
      });
      
      render(
        <TextColorPicker
          currentColor="#ffffff"
          onColorChange={mockOnChange}
          type="background"
        />
      );
      
      // Open dropdown and select blue
      const trigger = screen.getByRole('button');
      await user.click(trigger);
      
      const blueOptions = screen.getAllByTitle('Blue');
      const blueOption = blueOptions[0]; // Basic blue
      await user.click(blueOption);
      
      expect(mockOnChange).toHaveBeenCalledWith('#0000ff');
      expect(ModernFormatService.applyBackgroundColor).toHaveBeenCalledWith('#0000ff');
    });
  });

  describe('ColorUtils Integration', () => {
    test('validates hex colors using ColorUtils', () => {
      // Test ColorUtils.isValidHexColor
      expect(ColorUtils.isValidHexColor('#ff0000')).toBe(true);
      expect(ColorUtils.isValidHexColor('#FF0000')).toBe(true);
      expect(ColorUtils.isValidHexColor('ff0000')).toBe(false);
      expect(ColorUtils.isValidHexColor('#ff00')).toBe(false);
      expect(ColorUtils.isValidHexColor('invalid')).toBe(false);
    });

    test('converts hex to RGB using ColorUtils', () => {
      const rgb = ColorUtils.hexToRgb('#ff0000');
      expect(rgb).toEqual({ r: 255, g: 0, b: 0 });
      
      const invalidRgb = ColorUtils.hexToRgb('invalid');
      expect(invalidRgb).toBeNull();
    });

    test('converts RGB to hex using ColorUtils', () => {
      const hex = ColorUtils.rgbToHex(255, 0, 0);
      expect(hex).toBe('#ff0000');
      
      // Test bounds
      const boundedHex = ColorUtils.rgbToHex(300, -10, 128);
      expect(boundedHex).toBe('#ff0080');
    });

    test('calculates contrast ratio using ColorUtils', () => {
      const ratio = ColorUtils.getContrastRatio('#000000', '#ffffff');
      expect(ratio).toBeCloseTo(21, 0); // Black on white has ~21:1 ratio
      
      const lowRatio = ColorUtils.getContrastRatio('#ff0000', '#00ff00');
      expect(ratio).toBeGreaterThan(lowRatio);
    });

    test('checks WCAG contrast requirements', () => {
      expect(ColorUtils.meetsContrastRequirement('#000000', '#ffffff')).toBe(true);
      expect(ColorUtils.meetsContrastRequirement('#ffff00', '#ffffff')).toBe(false);
    });

    test('normalizes colors using ColorUtils', () => {
      expect(ColorUtils.normalizeColor('#ff0000')).toBe('#FF0000');
      expect(ColorUtils.normalizeColor('rgb(255, 0, 0)')).toBe('#ff0000');
      expect(ColorUtils.normalizeColor('red')).toBe('#FF0000');
      expect(ColorUtils.normalizeColor('invalid')).toBe('invalid');
    });

    test('gets readable text color using ColorUtils', () => {
      expect(ColorUtils.getReadableTextColor('#000000')).toBe('#FFFFFF');
      expect(ColorUtils.getReadableTextColor('#ffffff')).toBe('#000000');
    });

    test('lightens and darkens colors using ColorUtils', () => {
      const lightened = ColorUtils.lightenColor('#808080', 20);
      const darkened = ColorUtils.darkenColor('#808080', 20);
      
      expect(lightened).not.toBe('#808080');
      expect(darkened).not.toBe('#808080');
      expect(lightened).not.toBe(darkened);
    });
  });

  describe('Toolbar Integration', () => {
    test('works within toolbar context for text color', async () => {
      const user = userEvent.setup();
      const mockCommand = vi.fn();
      
      // Simulate toolbar integration
      const ToolbarWrapper = () => {
        const handleColorChange = (color: string) => {
          mockCommand('textColor', color);
        };
        
        return (
          <div className="editor-toolbar">
            <TextColorPicker
              currentColor="#000000"
              onColorChange={handleColorChange}
              type="text"
            />
          </div>
        );
      };
      
      render(<ToolbarWrapper />);
      
      const trigger = screen.getByRole('button');
      await user.click(trigger);
      
      const greenOptions = screen.getAllByTitle('Green');
      const greenOption = greenOptions[0]; // Basic green
      await user.click(greenOption);
      
      expect(mockCommand).toHaveBeenCalledWith('textColor', '#00ff00');
    });

    test('works within toolbar context for background color', async () => {
      const user = userEvent.setup();
      const mockCommand = vi.fn();
      
      // Simulate toolbar integration
      const ToolbarWrapper = () => {
        const handleColorChange = (color: string) => {
          mockCommand('backgroundColor', color);
        };
        
        return (
          <div className="editor-toolbar">
            <TextColorPicker
              currentColor="#ffffff"
              onColorChange={handleColorChange}
              type="background"
            />
          </div>
        );
      };
      
      render(<ToolbarWrapper />);
      
      const trigger = screen.getByRole('button');
      await user.click(trigger);
      
      const yellowOptions = screen.getAllByTitle('Yellow');
      const yellowOption = yellowOptions[0]; // Basic yellow
      await user.click(yellowOption);
      
      expect(mockCommand).toHaveBeenCalledWith('backgroundColor', '#ffff00');
    });
  });

  describe('Real-world Scenarios', () => {
    test('handles multiple color changes in sequence', async () => {
      const user = userEvent.setup();
      const colorHistory: string[] = [];
      
      const mockOnChange = vi.fn((color: string) => {
        colorHistory.push(color);
      });
      
      const { rerender } = render(
        <TextColorPicker
          currentColor="#000000"
          onColorChange={mockOnChange}
          type="text"
        />
      );
      
      // Change to red
      const trigger = screen.getByRole('button');
      await user.click(trigger);
      const redOptions = screen.getAllByTitle('Red');
      await user.click(redOptions[0]);
      
      // Re-render with new color
      rerender(
        <TextColorPicker
          currentColor="#ff0000"
          onColorChange={mockOnChange}
          type="text"
        />
      );
      
      // Change to blue
      await user.click(trigger);
      const blueOptions = screen.getAllByTitle('Blue');
      await user.click(blueOptions[0]);
      
      // Re-render with new color
      rerender(
        <TextColorPicker
          currentColor="#0000ff"
          onColorChange={mockOnChange}
          type="text"
        />
      );
      
      // Change to custom color
      await user.click(trigger);
      const hexInput = screen.getByLabelText('Custom color hex value');
      await user.clear(hexInput);
      await user.type(hexInput, '#ff00ff');
      
      expect(colorHistory).toEqual(['#ff0000', '#0000ff', '#ff00ff']);
      expect(mockOnChange).toHaveBeenCalledTimes(3);
    });

    test('maintains state consistency during rapid interactions', async () => {
      const user = userEvent.setup();
      let currentColor = '#000000';
      
      const mockOnChange = vi.fn((color: string) => {
        currentColor = color;
      });
      
      const { rerender } = render(
        <TextColorPicker
          currentColor={currentColor}
          onColorChange={mockOnChange}
          type="text"
        />
      );
      
      // Rapid sequence of changes
      const trigger = screen.getByRole('button');
      
      // Open and close rapidly
      await user.click(trigger);
      await user.keyboard('{Escape}');
      
      await user.click(trigger);
      const redOptions = screen.getAllByTitle('Red');
      await user.click(redOptions[0]);
      
      // Update component with new state
      rerender(
        <TextColorPicker
          currentColor="#ff0000"
          onColorChange={mockOnChange}
          type="text"
        />
      );
      
      // Verify final state
      const colorSample = document.querySelector('.text-color-picker__color-sample');
      expect(colorSample).toHaveStyle({ backgroundColor: '#ff0000' });
      expect(mockOnChange).toHaveBeenCalledWith('#ff0000');
    });
  });

  describe('Error Handling', () => {
    test('handles service errors gracefully', async () => {
      const user = userEvent.setup();
      
      // Mock service to throw error
      const mockOnChange = vi.fn(() => {
        throw new Error('Service error');
      });
      
      render(
        <TextColorPicker
          currentColor="#000000"
          onColorChange={mockOnChange}
          type="text"
        />
      );
      
      const trigger = screen.getByRole('button');
      await user.click(trigger);
      
      // Should not crash when service throws error
      expect(() => {
        const redOptions = screen.getAllByTitle('Red');
        const redOption = redOptions[0];
        user.click(redOption);
      }).not.toThrow();
    });
  });
});